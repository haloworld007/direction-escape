# 《乐消消·方向出走》

> 一款基于方向阻挡机制的休闲益智小游戏

---

## 游戏简介

《乐消消·方向出走》是一款轻松休闲的益智消除游戏。游戏中的每个动物方块都有固定的朝向（上/下/左/右），只有当朝向方向上没有其他方块阻挡时，才能点击消除。

### 核心特色

- 简单直观的点击玩法
- Q萌可爱的动物造型（猪、羊、狗、狐狸、熊猫）
- 循序渐进的关卡难度
- 4种辅助道具帮助通关
- 轻松愉快的游戏体验

### 技术栈

- **语言**: JavaScript ES6+
- **渲染**: Canvas 2D API
- **平台**: 微信小游戏
- **架构**: 单例模式 + 事件驱动
- **存储**: 微信本地存储 API

---

## 核心玩法

### 消除规则

**可消除判定**

一个方块可以被消除，当且仅当：从该方块出发，沿其朝向的直线方向上，直到屏幕边界为止，没有任何其他方块阻挡。

**消除流程**
1. 玩家点击方块
2. 系统检测朝向方向是否有阻挡
3. 若无阻挡 → 方块沿朝向滑出屏幕并消失
4. 若有阻挡 → 方块向阻挡位置滑动并抖动反馈

### 道具系统

游戏提供4种辅助道具：

1. **抓走**（蓝色）- 直接移除任意方块，无视方向与阻挡
2. **翻转**（黄色）- 所有方块的朝向整体反转 180°（上↔下，左↔右）
3. **洗牌位置**（紫色）- 随机重排所有方块的位置
4. **洗牌方向**（粉紫色）- 随机重排所有方块的朝向

### 胜负判定

- **胜利条件**：当前关卡中所有方块被成功消除
- **失败条件**：场上不存在任何一个可被消除的方块（死局）

---

## 技术架构

### 整体架构

```
┌─────────────────────────────────────┐
│         UI Layer (渲染层)             │
│  MenuRenderer | GameRenderer         │
│  ModalRenderer | BlockRenderer       │
└─────────────────────────────────────┘
                 ↕
┌─────────────────────────────────────┐
│      Game Logic (游戏逻辑)            │
│  DirectionGame (主控制器)             │
│  GameDataBus (全局状态)               │
└─────────────────────────────────────┘
                 ↕
┌─────────────────────────────────────┐
│      Core Systems (核心系统)          │
│  Block | LevelManager                │
│  DeadlockDetector | DirectionDetector│
└─────────────────────────────────────┘
                 ↕
┌─────────────────────────────────────┐
│      Base Layer (基础层)              │
│  Sprite | Pool | Particle            │
└─────────────────────────────────────┘
```

### 核心模块

#### DirectionGame（游戏主控制器）
**职责**：游戏主循环管理、输入事件分发、UI状态切换、道具效果控制

**源码**：`/js/game/DirectionGame.js` (698行)

#### GameDataBus（全局状态管理）
**职责**：方块集合管理、关卡进度存储、道具数量控制、本地数据持久化

**核心属性**：
- `blocks: []` - 当前方块数组
- `totalBlocks: 0` - 方块总数
- `removedBlocks: 0` - 已消除数
- `items: {}` - 道具数量
- `unlockedLevels: 1` - 已解锁关卡

**源码**：`/js/game/GameDataBus.js` (195行)

#### Block（方块实体）
**职责**：方块状态维护、消除动画控制、碰撞盒计算、朝向几何更新

**关键特性**：
- 对角线朝向（45°旋转）
- 胶囊状造型（3:1 长宽比）
- 平滑滑出动画（easeInOutCubic）
- 抖动反馈效果

**源码**：`/js/game/blocks/Block.js` (475行)

---

## 源码目录结构

```
direction-escape/
├── js/
│   ├── game/
│   │   ├── DirectionGame.js        # 游戏主控制器
│   │   ├── GameDataBus.js          # 全局状态管理
│   │   ├── LevelManager.js         # 关卡管理器
│   │   ├── blocks/
│   │   │   └── Block.js            # 方块实体类
│   │   └── algorithms/
│   │       ├── DirectionDetector.js    # 方向检测算法
│   │       ├── DeadlockDetector.js     # 死局检测算法
│   │       └── LevelGenerator.js       # 关卡生成器
│   ├── ui/
│   │   ├── UIConstants.js         # UI常量配置
│   │   ├── MenuRenderer.js        # 菜单渲染器
│   │   ├── GameRenderer.js        # 游戏界面渲染器
│   │   ├── ModalRenderer.js       # 弹窗渲染器
│   │   ├── BlockRenderer.js       # 方块渲染器（1099行）
│   │   ├── Button.js              # 按钮组件
│   │   └── PropButton.js          # 道具按钮组件
│   ├── audio/
│   │   ├── AudioManager.js        # 音频管理器
│   │   └── AudioConfig.js         # 音频配置
│   ├── base/
│   │   ├── sprite.js              # 精灵基类
│   │   ├── pool.js                # 对象池
│   │   └── particle.js            # 粒子效果
│   ├── libs/
│   │   └── tinyemitter.js         # 事件总线
│   ├── main.js                    # 入口文件
│   └── render.js                  # 渲染初始化
├── audio/                          # 音频资源
├── images/                         # 图片资源
├── docs/                          # 文档
│   ├── PRD.md                     # 产品需求文档
│   └── CODE_REVIEW_REPORT.md      # 代码审查报告
├── game.js                        # 游戏逻辑入口
├── game.json                      # 游戏配置
└── README.md                      # 项目说明
```

---

## 核心功能实现

### 方向检测算法

**算法原理**：使用射线检测法判断方块是否被阻挡

1. 从方块中心发出射线
2. 沿朝向方向逐步检测
3. 判断射线点是否进入其他方块的AABB碰撞盒
4. 到达屏幕边界前无碰撞 → 可消除

**实现细节**：
- 支持网格优先检测（提升性能）
- 回退射线检测（兼容无网格数据）
- 对角线方向向量：±1/√2
- 检测步长：8px

**性能特点**：
- 网格模式：O(n) → O(1)
- 射线模式：O(n × steps)
- 最大步数限制：1000

**源码**：`/js/game/algorithms/DirectionDetector.js` (394行)

### 关卡生成器

**生成策略**：旋转网格 + 双格方块布局

1. 正方形网格生成格子
2. 整体旋转45度（对角线方向）
3. 每个动物占据两个相邻格子
4. 中心向外填充方块

**难度参数**：
- Level 1-3: 80-92方块，大尺寸（18px）
- Level 4-10: 102-138方块，中尺寸（16px）
- Level 11-20: 131-176方块，小尺寸（14px）
- Level 20+: 155-220方块，小尺寸（14px）

**可解性保证**：
- 预生成多轮布局（最多6次尝试）
- 确保初始可消除方块 ≥ 20%
- 路径可解性验证（随机模拟消除）

**源码**：`/js/game/algorithms/LevelGenerator.js` (796行)

### 死局检测

**检测逻辑**：遍历所有未消除方块，检测是否存在至少一个可消除方块

- 存在 → 非死局，继续游戏
- 不存在 → 死局，显示失败弹窗

**实现位置**：每次方块消除后自动调用

**源码**：`/js/game/algorithms/DeadlockDetector.js` (66行)

---

## 开发说明

### UI常量配置

所有视觉相关参数集中在 `UIConstants.js`，便于统一调整：

**颜色方案**
```javascript
COLORS = {
  BACKGROUND_START: '#E3F2FD',  // 背景渐变
  ANIMAL_PIG: '#FFB6C1',        // 动物颜色
  PROP_GRAB: '#2196F3',         // 道具颜色
  // ...
}
```

**方块尺寸**
```javascript
BLOCK_SIZES = {
  LENGTH: 54,      // 长边（3:1比例）
  WIDTH: 18,       // 短边
  CORNER_RADIUS: 9,
  HITBOX_INSET: 4, // 碰撞内缩
}
```

**源码**：`/js/ui/UIConstants.js`

### 动物渲染系统

**渲染架构**
- 主体：修长胶囊状身体（3:1比例）
- 旋转：对角线方向45度旋转
- 特征：头部眼睛、鼻子、耳朵、尾巴

**5种动物类型**
1. **猪**（粉色）- 大椭圆鼻子、卷曲尾巴
2. **羊**（白色）- 深色脸、下垂耳朵、蓬松尾巴
3. **狗**（橙黄）- 浅色口鼻、垂耳、翘尾巴
4. **狐狸**（橙红）- 尖三角耳、白色下颌、白尖尾巴
5. **熊猫**（黑白）- 标志性黑眼圈、圆耳朵

**绘制技术**
- 贝塞尔曲线绘制流线型身体
- 线性渐变实现立体感
- 柔和阴影和高光效果
- 颜色自动变亮/变暗工具

**源码**：`/js/ui/BlockRenderer.js` (1099行)

---

## 最近更新

### v2.0.0 (最新版本)

#### 核心玩法优化
- ✨ 引入对角线方向系统（45°旋转）
- ✨ 扩展动物种类（新增狐狸、熊猫）
- 🎨 精细化调整关卡平衡
- 🐛 修复方向检测误判问题

#### 关卡生成算法
- ✨ 引入轴向概念（row/col）
- ✨ 增强路径可解性验证
- ✨ 优化方块布局算法（旋转网格+双格方块）
- 📈 提升关卡质量（100%可解验证）

#### UI视觉全面焕新
- 🎨 从木质主题改为草地主题
- ✨ 5种动物精细特征绘制
- 🎨 草地背景+木质棋盘融合设计
- ✨ 优化按钮样式和交互反馈

#### 道具系统实现
- ✨ 4种道具完整实现（抓走、翻转、洗牌位置、洗牌方向）
- 🎨 道具UI重构（圆角矩形按钮）
- 🔊 道具音效和动画
- 💾 道具数量本地持久化

#### 架构重构
- 🏗️ 重构核心玩法逻辑
- 🗑️ 清理旧资源和冗余代码
- 📦 模块化拆分（algorithms目录）
- 📝 代码注释和文档完善

---

**开发**: Claude Code AI Assistant
**最后更新**: 2026-01-16
