# 关卡生成逻辑分析与改进方案

## 1. 现状分析

目前的 `LevelGenerator.js` 主要采用 **“随机几何撒点” + “物理碰撞推开” + “蒙特卡洛模拟（随机试玩）”** 的方式来生成和验证关卡。

### 核心机制
- **布局**：通过随机选择预设的几何模板（如 `HOLE_TEMPLATES`）进行方块放置。
- **验证**：使用 `hasSolvablePath` 方法，通过多次随机尝试消除来判断关卡是否可解。
- **难度控制**：主要依赖 `blockCount`（方块数量）和 `avgDepth`（平均阻挡层数）作为难度指标。

## 2. 存在的问题

这种基于“随机模拟”的方案在游戏后期（高难度、多方块）面临以下核心问题：

### A. 可解性验证过于粗糙（假阳性风险）
- **现象**：`hasSolvablePath` 只要在某一次随机尝试中成功消除所有方块，就判定关卡为“可解”。
- **隐患**：这只证明了“存在上帝视角的解”，无法识别“陷阱布局”。
- **后果**：可能生成 99% 的消除顺序都会导致死局，只有 1% 的特定顺序能过的关卡。系统认为是合法的，但玩家体验极差，感觉像是在玩纯运气游戏。

### B. 死锁（Deadlock）控制效率低
- **现象**：`estimateDeadlockProbability` 通过跑多次模拟来估算死锁率，如果不符合 `deadlockProbRange` 就丢弃重来。
- **隐患**：这是一种**被动筛选**。在高难度下，死锁概率自然升高，导致生成器可能需要丢弃大量“废品”才能碰巧得到一个符合要求的关卡，性能开销巨大。
- **后果**：难以精确控制难度曲线，比如很难精准生成“死锁风险为 50%”的关卡。

### C. 难度参数与体验脱节
- **现象**：目前难度主要靠堆砌方块数量（Quantity）和增加遮挡层数。
- **隐患**：数量多不等于难，可能只是“繁琐”。真正的难度在于**依赖关系的复杂度**和**容错率**。
- **后果**：目前的算法无法区分“简单层叠”和“复杂逻辑锁”，导致第 50 关可能比第 30 关玩起来更简单，难度曲线波动大。

## 3. 改进方案 Plan

为了从根本上控制难度递增，建议引入 **“依赖图 (Dependency Graph)”** 的概念，从“概率模拟”转向“逻辑分析”。

### 核心概念：依赖图
- **节点**：每个方块。
- **边 (A -> B)**：方块 A 挡住了方块 B（必须先消 A 才能消 B）。
- **环 (Cycle)**：死锁（A->B->C->A）。
- **入度**：多少个方块挡住了当前方块。

### Phase 1: 改进验证逻辑 —— 引入“容错率”检查 (短期)
**目标**：确保低难度关卡“随便点都能过”，高难度关卡“必须动脑子”。

*   **Action**：修改 `validateLevel`，不再只看是否可解，而是计算 **“陷阱比例”**。
*   **新指标**：
    *   **Safe Moves (安全步数)**：当前局面下，移走哪些方块**不会**导致剩余局面进入死锁？
    *   **难度判定**：
        *   **Easy**：安全步数 / 总可一步数 $\approx$ 100%。
        *   **Hard**：安全步数极少，陷阱步数极多。

### Phase 2: 基于依赖图的“死锁修复” (中期)
**目标**：不再因为有死锁就直接丢弃关卡，而是智能修复它，提高生成效率。

*   **Action**：
    1.  构建依赖图。
    2.  检测图中的 **环 (Cycle)**。
    3.  **智能破环**：找到环中约束最少、最容易改变方向的节点，旋转它，使其不再指向环的下一节点。
    4.  这能保留复杂的纠缠结构，只打破死结。

### Phase 3: 结构化的难度递增策略 (长期)
**目标**：构建平滑且有梯度的难度曲线。

*   **Level 1-10 (新手期)**：
    *   生成策略：保证依赖图是 **森林 (Forest)** 结构，没有复杂的网状交叉依赖。
    *   体验：直观，无脑消除。
*   **Level 11-30 (进阶期)**：
    *   生成策略：允许 **DAG (有向无环图)** 的网状依赖（多挡一，一挡多）。
    *   验证：允许少量陷阱。
*   **Level 30+ (大师期)**：
    *   生成策略：构建 **瓶颈 (Bottleneck)** 结构。
    *   体验：整个盘面被锁死，突破口只有底层的某一个关键方块（Key Block），需要先进行一系列精确的解谜操作。
