# 关卡生成重构与难度曲线设计方案 (The "Reverse Generation" Overhaul)

## 1. 当前实现的问题 (Problems)

经过深入分析，当前的 `LevelGenerator.js` 存在以下根本性问题，无法满足“硬核难度”和“精确控制”的需求：

1.  **生成逻辑的先天缺陷 (Fundamental Flaw)**
    *   **现状**：先随机撒点，再把重叠的推开，最后随机试玩验证。
    *   **问题**：这本质上是在撞大运。它无法生成严密的逻辑陷阱。由于是“正向生成”（先放底层再放上层），算法很难预知这一步放置会对最终的可解性造成什么破坏，只能事后补救（验证失败就重来）。
    *   **结果**：高难度关卡要么是死局，要么是运气局，缺乏逻辑美感。

2.  **难度控制失效 (Uncontrollable Difficulty)**
    *   **现状**：依靠“方块数量”和“平均层数”控制。
    *   **问题**：数量 $\neq$ 难度。真正的难度来自于**依赖链的纠缠度**（例如：必须先解开左上角才能解开右下角）。目前的算法无法通过参数精确制造这种纠缠。

3.  **节奏拖沓 (Pacing Issues)**
    *   **现状**：设计了 1-10 关的漫长新手期。
    *   **问题**：对于此类直觉解谜游戏，玩家只需要一关就能理解核心机制。漫长的新手期会消磨耐心。

## 2. 解决方案 (The Plan)

我们将**完全废弃**现有的随机撒点算法，采用 **“逆向填空生成法 (Reverse Filling Generation)”**。

### A. 核心算法：逆向生成 (Reverse Generation)

**原理**：
游戏的玩法是将方块从中间向四周“移出”。
生成的逻辑正好相反：我们将方块从四周向中间“射入”。

**算法流程**：
1.  **初始化**：从一个空的棋盘开始。
2.  **逆向发射**：
    *   在棋盘边缘随机选择一个位置和方向（例如：从上方发射一个向下指的方块）。
    *   让方块沿反方向“滑入”场内，直到它**碰到**现有的方块或者达到预设的停止线。
    *   在停止位置固定该方块。
3.  **构建依赖**：
    *   因为这个方块是“最后射入”的，所以在正常游玩时，它一定是“最先移出”的（或者是较早移出的）。
    *   它自然地“挡住”了它滑行路径深处的空位。如果我们后续在它深处放了方块，就连成了天然的 `被挡 -> 挡路` 依赖链。
4.  **循环**：重复上述过程，直到方块数量达到目标。

**优势**：
*   **100% 可解**：所有生成的关卡，按生成的逆序操作绝对能解。
*   **精确控制结构**：如果我们想制造“锁”，就故意让一个新射入的方块同时挡住内部的两个方块。

### B. 全新的难度曲线 (Difficulty Curve)

#### Level 1: 极简教学 (The Tutorial)
*   **目标**：3秒上手。
*   **配置**：
    *   **数量**：5 个。
    *   **尺寸**：**1.5倍** (需要前端渲染支持缩放)。
    *   **逻辑**：无遮挡或仅 1 对遮挡。
    *   **视觉**：在大屏幕中央，一目了然。

#### Level 2: 难度飙升 (The Spike)
*   **目标**：给玩家当头一棒，展示游戏深度。
*   **配置**：
    *   **数量**：直接跃升至 **40-50 个**。
    *   **尺寸**：恢复正常 (1.0倍)。
    *   **逻辑**：引入“3层依赖”（A挡B，B挡C），玩家不能乱点，必须找最外层。
    *   **UI 交互**：进入关卡时，屏幕出现 **"WARNING: DIFFICULTY SPIKE / 难度飙升"** 的红色警示动画。

#### Level 3+: 递增挑战 (The Climb)
*   **变量控制**：
    *   **密度 (Density)**：从 50 个线性增加到 200+。
    *   **交织度 (Interleaving)**：(逆向生成特有参数)
        *   *低难度*：倾向于在空白处射入方块（扁平结构）。
        *   *高难度*：倾向于在已有方块的缝隙中射入方块（高层叠结构，制造“一线天”）。
    *   **视觉干扰**：高难度下，故意将同色方块放置在互不相关的依赖链上，干扰玩家判断。

## 3. 实施计划 (Implementation Roadmap)

1.  **Phase 1: 核心重写 (Worker)**
    *   创建 `ReverseLevelGenerator.js`。
    *   实现基于 Grid 的逆向射线检测逻辑（Raycasting on Grid）。
    *   替换 `workers/levelGenerator.js` 的主入口。

2.  **Phase 2: 难度配置器 (Difficulty Manager)**
    *   实现一个新的参数生成函数，根据 Level ID 返回：`blockCount`, `scale`, `interleavingFactor` 等。
    *   硬编码 Level 1 和 Level 2 的特殊配置。

3.  **Phase 3: 前端适配 (Frontend)**
    *   修改 `BlockRenderer` 支持 `scale` 属性（为了 Level 1）。
    *   修改 `DirectionGame.js`，在 Level 2 加载时触发 `UI.showWarning("难度飙升")`。

4.  **Phase 4: 验证与微调**
    *   生成前 5 关进行试玩，调整 Level 2 的冲击力是否适中。
